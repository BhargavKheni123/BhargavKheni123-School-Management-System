@model digital.ViewModels.TimeTableViewModel

@{
    ViewData["Title"] = "Time Table Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var role = Context.Session.GetString("UserRole");
}

<style>
    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .card-header {
        background: #3a3a3a;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
    }

    .form-select, .form-control {
        border-radius: 6px;
        padding: 8px 10px;
        border: 1px solid #bbb;
        box-shadow: none;
        transition: border-color 0.2s ease;
    }

        .form-select:focus, .form-control:focus {
            border-color: #3a3a3a;
            outline: none;
        }

    .btn-primary {
        background-color: #3a3a3a;
        border: none;
    }

        .btn-primary:hover {
            background-color: #555;
        }
</style>

<div class="content-wrapper">
    <section class="content">
        <div class="container-fluid">

            @if (role == "Student")
            {
                <div class="row justify-content-center mt-4">
                    <div class="col-lg-10">
                        <div class="card shadow-sm">
                            <div class="card-header text-center">Student Timetable</div>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="text-center">
                                        <tr>
                                            <th>Subject</th>
                                            <th>Start Hour</th>
                                            <th>End Hour</th>
                                            <th>Teacher</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.TimeTableList)
                                        {
                                            <tr class="text-center">
                                                <td>@item.Subject</td>
                                                <td>@item.StartHour:@item.StartMinute.ToString("D2")</td>
                                                <td>@item.EndHour:@item.EndMinute.ToString("D2")</td>
                                                <td>@item.Teacher?.Name</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            }
            @if (role == "Teacher")
            {
                <div class="row justify-content-center mt-4">
                    <div class="col-lg-10">
                        <div class="card shadow-sm">
                            <div class="card-header text-center">Timetable</div>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="text-center">
                                        <tr>
                                            <th>Subject</th>
                                            <th>Standard</th>
                                            <th>Class</th>
                                            <th>Start Hour</th>
                                            <th>End Hour</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.TimeTableList)
                                        {
                                            <tr class="text-center">
                                                <td>@item.Subject</td>
                                                <td>@item.Std</td>
                                                <td>@item.Class</td>
                                                <td>@item.StartHour:@item.StartMinute.ToString("D2")</td>
                                                <td>@item.EndHour:@item.EndMinute.ToString("D2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="row justify-content-center mt-4">
                    <div class="col-lg-10">
                        <div class="card shadow-sm">
                            <div class="card-header text-center">Time Table - Assign Lectures</div>
                            <div class="card-body">

                                @if (ViewBag.Message != null || !string.IsNullOrEmpty(Model.Message))
                                {
                                    <div class="alert alert-success text-center">
                                        @(!string.IsNullOrEmpty(Model.Message) ? Model.Message : ViewBag.Message)
                                    </div>
                                }

                                @if (TempData["FormErrors"] != null)
                                {
                                    <div class="alert alert-danger">@TempData["FormErrors"]</div>
                                }

                                <form asp-action="TimeTableForm" method="post" id="ttForm">
                                    @Html.AntiForgeryToken()
                                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                                    <!-- Row 1 -->
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Teacher</label>
                                            <select asp-for="TimeTable.TeacherId" asp-items="Model.TeacherList" class="form-select shadow-sm">
                                                <option value="">-- Select Teacher --</option>
                                            </select>
                                        </div>

                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Standard</label>
                                            <select id="Std" name="TimeTable.Std" class="form-select shadow-sm" required>
                                                <option value="">-- Select Standard --</option>
                                                @foreach (var item in Model.StdList)
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            </select>
                                        </div>

                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Class</label>
                                            <select id="Class" name="TimeTable.Class" class="form-select shadow-sm" required>
                                                <option value="">-- Select Class --</option>
                                            </select>
                                        </div>

                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Subject</label>
                                            <select asp-for="TimeTable.Subject" class="form-select shadow-sm" required>
                                                <option value="">-- Select Subject --</option>
                                                <option>English</option>
                                                <option>Mathematics</option>
                                                <option>Science</option>
                                                <option>History</option>
                                                <option>Computer</option>
                                                <option>Hindi</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Row 2 -->
                                    <div class="row g-3 align-items-end mt-1">
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Start Hour</label>
                                            <select asp-for="TimeTable.StartHour" asp-items="Model.Hours" class="form-select shadow-sm" id="StartHour" required>
                                                <option value="">-- Hour --</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Start Minute</label>
                                            <select asp-for="TimeTable.StartMinute" asp-items="Model.Minutes" class="form-select shadow-sm" id="StartMinute" required>
                                                <option value="">-- Minute --</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">End Hour</label>
                                            <select asp-for="TimeTable.EndHour" asp-items="Model.Hours" class="form-select shadow-sm" id="EndHour" required>
                                                <option value="">-- Hour --</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">End Minute</label>
                                            <select asp-for="TimeTable.EndMinute" asp-items="Model.Minutes" class="form-select shadow-sm" id="EndMinute" required>
                                                <option value="">-- Minute --</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Submit -->
                                    <div class="text-center mt-4">
                                        <button id="submitBtn" type="submit" class="btn btn-primary px-5 py-2 fw-bold rounded-pill shadow-sm">
                                            Submit
                                        </button>
                                    </div>
                                </form>


                                <!-- Table -->
                                <div class="card mt-5 shadow-sm border-0">
                                    <div class="card-header">Time Table Entries</div>
                                    <div class="card-body table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="text-center">
                                                <tr>
                                                    <th>Standard</th>
                                                    <th>Class</th>
                                                    <th>Subject</th>
                                                    <th>Teacher</th>
                                                    <th>Start</th>
                                                    <th>End</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (Model.TimeTableList != null && Model.TimeTableList.Count > 0)
                                                {
                                                    foreach (var item in Model.TimeTableList)
                                                    {
                                                        <tr class="text-center">
                                                            <td>@item.Std</td>
                                                            <td>@item.Class</td>
                                                            <td>@item.Subject</td>
                                                            <td>@item.Teacher?.Name</td>
                                                            <td>@item.StartHour:@item.StartMinute.ToString("D2")</td>
                                                            <td>@item.EndHour:@item.EndMinute.ToString("D2")</td>
                                                            <td>
                                                                <a href="/Home/EditTimeTable/@item.Id" class="btn btn-warning btn-sm">Edit</a>
                                                                <a href="/Home/DeleteTimeTable/@item.Id" class="btn btn-danger btn-sm">Delete</a>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted">No entries found.</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            }

        </div>
    </section>
</div>

@section Scripts {
    <script>
        $(function () {
            $('#Std').on('change', function () {
                var stdName = $(this).val();
                $('#Class').empty().append('<option value="">Loading...</option>');
                $.get('/Home/GetSubCategoriesByStd', { stdName: stdName }, function (data) {
                    $('#Class').empty().append('<option value="">-- Select Class --</option>');
                    $.each(data, function (i, item) {
                        $('#Class').append('<option value="' + item.name + '">' + item.name + '</option>');
                    });
                }).fail(function () {
                    $('#Class').empty().append('<option value="">-- Error loading --</option>');
                });
            });

            $('#StartHour, #StartMinute').on('change', function () {
                var startHour = parseInt($('#StartHour').val() || '0', 10);
                var startMinute = parseInt($('#StartMinute').val() || '0', 10);

                $('#EndHour').empty().append('<option value="">-- Hour --</option>');
                $('#StartHour option').each(function () {
                    var v = $(this).val();
                    if (!v) return;
                    var hv = parseInt(v, 10);
                    if (hv >= startHour) {
                        $('#EndHour').append($(this).clone());
                    }
                });

                $('#EndHour').on('change', function () {
                    var endHour = parseInt($(this).val() || '0', 10);
                    $('#EndMinute').empty().append('<option value="">-- Minute --</option>');
                    $('#StartMinute option').each(function () {
                        var mval = $(this).val();
                        if (mval === '') return;
                        var mv = parseInt(mval, 10);
                        if (endHour === startHour) {
                            if (mv > startMinute) $('#EndMinute').append($(this).clone());
                        } else {
                            $('#EndMinute').append($(this).clone());
                        }
                    });
                });
            });

            $('#ttForm').on('submit', function () {
                $('#submitBtn').prop('disabled', true).text('Saving...');
            });
        });
    </script>
}
