@model digital.ViewModels.AttendanceViewModel

@{
    ViewData["Title"] = "Attendance Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var selectedMonth = Model.SelectedMonth ?? 0;
    var selectedYear = Model.SelectedYear ?? 0;
    var isStudent = Model.IsStudent;
    var role = Context.Session.GetString("Role");
}

@section Styles {
    <style>
        .attendance-wrapper {
            padding: 20px;
            margin-left: 250px;
        }

        .table thead th {
            text-align: center;
            background-color: #343a40;
            color: white;
        }

        .table tbody td {
            text-align: center;
        }

        .form-control, .btn {
            margin-bottom: 10px;
        }
    </style>
}

<div class="content-wrapper attendance-wrapper">
    <h2 class="mb-4">Student Attendance Form</h2>
    <form method="get" asp-action="AttendanceForm" id="attendanceForm">
        <div class="row">
            <div class="col-md-3">
                <label asp-for="SelectedCategoryId">Standard</label>
                <select class="form-control" asp-for="SelectedCategoryId" asp-items="Model.Categories" required>
                    <option value="">-- Select Standard --</option>
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="SelectedSubCategoryId">Class</label>
                <select class="form-control" asp-for="SelectedSubCategoryId" asp-items="Model.SubCategories" required>
                    <option value="">-- Select Class --</option>
                </select>
            </div>

            <div class="col-md-2">
                <label>Month</label>
                <select class="form-control" name="Month" required>
                    <option value="">-- Month --</option>
                    @for (int m = 1; m <= 12; m++)
                    {
                        var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m);
                        if (m == selectedMonth)
                        {
                            <option value="@m" selected>@monthName</option>
                        }
                        else
                        {
                            <option value="@m">@monthName</option>
                        }
                    }
                </select>

            </div>

            <div class="col-md-2">
                <label>Year</label>
                <select class="form-control" name="Year" required>
                    <option value="">-- Year --</option>
                    @for (int y = 2025; y <= 2050; y++)
                    {
                        if (y == selectedYear)
                        {
                            <option value="@y" selected>@y</option>
                        }
                        else
                        {
                            <option value="@y">@y</option>
                        }
                    }
                </select>

            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-danger w-100">Generate Sheet</button>
            </div>
        </div>
    </form>

    @if (Model.Student != null && Model.Student.Count > 0 && Model.TotalDays > 0)
    {
        <form method="post" asp-action="AttendanceForm">
            <input type="hidden" name="SelectedCategoryId" value="@Model.SelectedCategoryId" />
            <input type="hidden" name="SelectedSubCategoryId" value="@Model.SelectedSubCategoryId" />
            <input type="hidden" name="SelectedMonth" value="@Model.SelectedMonth" />
            <input type="hidden" name="SelectedYear" value="@Model.SelectedYear" />

            <table class="table table-bordered mt-4">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        @for (int d = 1; d <= Model.TotalDays; d++)
                        {
                            <th>@d</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var student in Model.Student)
                    {
                        <tr>
                            <td>@student.Name</td>
                            @for (int d = 1; d <= Model.TotalDays; d++)
                            {
                                var checkedStatus = Model.AttendanceData.Any(a =>
                                    a.StudentId == student.Id &&
                                    a.Day == d &&
                                    a.Month == Model.SelectedMonth &&
                                    a.Year == Model.SelectedYear &&
                                    a.Attend == "Yes");

                                <td>
                                    <input type="hidden" name="attend_@(student.Id)_@(d)" value="No" />
                                    <input type="checkbox"
                                           name="attend_@(student.Id)_@(d)"
                                           class="attendance-checkbox"
                                           data-studentid="@student.Id"
                                           data-day="@d"
                                           data-month="@Model.SelectedMonth"
                                           data-year="@Model.SelectedYear"
                                           @(checkedStatus ? "checked" : "") />
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>

            <button type="submit" class="btn btn-dark">Save</button>
        </form>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Load SubCategories dynamically
            $('[name="SelectedCategoryId"]').change(function () {
                var categoryId = $(this).val();
                $.ajax({
                    url: '/Home/GetSubCategories?categoryId=' + categoryId,
                    type: 'GET',
                    success: function (data) {
                        var subDropdown = $('[name="SelectedSubCategoryId"]');
                        subDropdown.empty();
                        subDropdown.append('<option value="">-- Select Class --</option>');
                        $.each(data, function (i, item) {
                            subDropdown.append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    }
                });
            });

            // Save on checkbox change
            $('.attendance-checkbox').on('change', function () {
                var checkbox = $(this);
                var studentId = checkbox.data('studentid');
                var day = checkbox.data('day');
                var month = checkbox.data('month');
                var year = checkbox.data('year');
                var isChecked = checkbox.is(':checked');

                $.ajax({
                    url: '/Home/SaveAttendanceAjax',
                    method: 'POST',
                    data: {
                        studentId: studentId,
                        day: day,
                        month: month,
                        year: year,
                        status: isChecked ? 'Yes' : 'No'
                    },
                    success: function (response) {
                        console.log("Saved successfully");
                    }
                });
            });
        });
    </script>
}
