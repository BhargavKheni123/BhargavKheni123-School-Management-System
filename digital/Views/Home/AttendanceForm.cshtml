@model digital.ViewModels.AttendanceViewModel
@if (ViewBag.Error != null)
{
    <div class="alert alert-warning">@ViewBag.Error</div>
}

@{
    ViewData["Title"] = "Attendance Form";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var selectedMonth = ViewBag.SelectedMonth ?? 0;
    var selectedYear = ViewBag.SelectedYear ?? 0;
    var isStudent = ViewBag.IsStudent != null && (bool)ViewBag.IsStudent;
    var role = Context.Session.GetString("Role");
}

@if (isStudent)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 100vh; background-color: #f8f9fa;">
        <div class="card shadow-lg" style="width: 600px;">
            <div class="card-header text-white text-center fw-bold" style="background-color: #222;">
                STUDENT DETAILS
            </div>

            <div class="card-body">
                <h4>Your Attendance Records</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.AttendanceData)
                        {
                            <tr>
                                <td>@($"{item.Day}/{item.Month}/{item.Year}")</td>
                                <td>
                                    @if (item.Attend == "Yes")
                                    {
                                        <span style="color: green;">✔️ Present</span>
                                    }
                                    else
                                    {
                                        <span style="color: red;">✖️ Absent</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="content-wrapper px-4 py-3" style="margin-left: 250px;">
        <h2 class="mb-4">Student Attendance Form</h2>

     <form method="get" asp-action="AttendanceForm" id="attendanceForm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label asp-for="SelectedCategoryId">Standard</label>
                    <select asp-for="SelectedCategoryId" asp-items="Model.Categories" class="form-control" required id="CategoryId">
                        <option value="">-- Select Standard --</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label asp-for="SelectedSubCategoryId">Class</label>
                    <select asp-for="SelectedSubCategoryId" asp-items="Model.SubCategories" class="form-control" required id="SubCategoryId">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label asp-for="SelectedMonth">Month</label>
                    <select asp-for="SelectedMonth" class="form-control" required>
                        <option value="">-- Month --</option>
                        @for (int m = 1; m <= 12; m++)
                        {
                            var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m);
                            <option value="@m">@monthName</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label asp-for="SelectedYear">Year</label>
                    <select asp-for="SelectedYear" class="form-control" required>
                        <option value="">-- Year --</option>
                        @for (int y = 2025; y <= 2050; y++)
                        {
                            <option value="@y">@y</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-danger w-100">Generate Sheet</button>
                </div>
            </div>
      

            

          @if (Model.Student != null && Model.Student.Any() && Model.TotalDays > 0)
            {
                <hr />
                <div class="table-responsive mt-4">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                @for (int d = 1; d <= ViewBag.TotalDays; d++)
                                {
                                    <th>@d</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                             @foreach (var student in Model.Student)
                        {
                            <tr>
                                <td>@student.Name</td>
                                @for (int d = 1; d <= Model.TotalDays; d++)
                                {
                                    bool isChecked = Model.AttendanceData?.Any(att =>
                                    att.StudentId == student.Id &&
                                    att.Day == d &&
                                    att.Month == selectedMonth &&
                                    att.Year == selectedYear &&
                                    att.Attend == "Yes"
                                    ) ?? false;


                                    <td>
                                        <input type="hidden" name="attend_@(student.Id)_@(d)" value="No" />
                                        <input type="checkbox"
                                               name="attend_@(student.Id)_@(d)"
                                               class="attendance-checkbox"
                                               data-studentid="@student.Id"
                                               data-day="@d"
                                               data-month="@ViewBag.SelectedMonth"
                                               data-year="@ViewBag.SelectedYear"
                                               @(isChecked ? "checked" : "") />

                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                    </table>
                </div>

                <div class="col-md-2 mt-3">
                    <button type="submit" class="btn btn-dark w-100">Save</button>
                </div>
            }
        </form>
    </div>
}

@section Styles {
    <style>
        .table thead th {
            text-align: center;
            background-color: #343a40;
            color: white;
        }

        .table tbody td {
            text-align: center;
        }
    </style>
}
@section Scripts {
    <script>
        $(document).ready(function () {

            $('#CategoryId').change(function () {
                var categoryId = $(this).val();
                $.ajax({
                    url: '/Home/GetSubCategories?categoryId=' + categoryId,
                    type: 'GET',
                    success: function (data) {
                        var subDropdown = $('#SubCategoryId');
                        subDropdown.empty();
                        subDropdown.append('<option value="">-- Select Class --</option>');
                        $.each(data, function (i, item) {
                            subDropdown.append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    }
                });
            });

            $('.attendance-checkbox').on('change', function () {
                var checkbox = $(this);
                var studentId = checkbox.data('studentid');
                var day = checkbox.data('day');
                var month = checkbox.data('month');
                var year = checkbox.data('year');
                var isChecked = checkbox.is(':checked');

                $.ajax({
                    url: '/Home/SaveAttendanceAjax',
                    method: 'POST',
                    data: {
                        studentId: studentId,
                        day: day,
                        month: month,
                        year: year,
                        status: isChecked ? 'Yes' : 'No'
                    },
                    success: function (response) {
                        console.log("Attendance saved for student " + studentId + " on day " + day);
                    },
                    error: function (xhr) {
                        console.error("Error saving attendance:", xhr.responseText);
                        alert("Saving failed!");
                    }
                });
            });
        });
    </script>
}
}
