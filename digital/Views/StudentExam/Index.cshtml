@{
    ViewData["Title"] = "Exam list";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">

            <div class="text-center mb-4">
                <h2>Exam list</h2>
                <p>
                    <strong>Std:</strong> @ViewBag.Std |
                    <strong>Student:</strong> @ViewBag.StudentName
                </p>
            </div>

            @if (ViewBag.NoExamMsg != null)
            {
                <div class="alert alert-warning text-center">
                    @ViewBag.NoExamMsg
                </div>
            }
            else
            {
                foreach (var exam in ViewBag.Exams)
                {
                    <div class="card shadow-sm mb-4 p-3">
                        <h4>
                            Subject: <strong>@exam.SubjectName</strong> |
                            Exam Type: @exam.ExamType |
                            Date: @exam.ExamDate
                        </h4>
                        <p><strong>Status:</strong> @exam.Status</p>

                        @if (exam.Status == "Available")
                        {
                            <h5 class="text-danger">Time Left: <span id="timer-@exam.SubjectId"></span></h5>

                            <form asp-action="SubmitExam" method="post" id="examForm-@exam.SubjectId">
                                @for (int i = 0; i < exam.Questions.Count; i++)
                                {
                                    var q = exam.Questions[i];
                                    <div class="card mb-3 p-3 border">
                                        <h6>Q@(i + 1). @q.QuestionText</h6>
                                        @foreach (var option in q.AnswerOptions)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input"
                                                       type="radio"
                                                       name="answers[@i].SelectedAnswer"
                                                       value="@option.OptionText"
                                                       required />
                                                <label class="form-check-label">@option.OptionText</label>
                                            </div>
                                        }
                                        <input type="hidden" name="answers[@i].QuestionId" value="@q.Id" />
                                    </div>
                                }
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">Submit @exam.SubjectName Exam</button>
                                </div>
                            </form>

                            <script>
                                (function () {
                                    const examEnd = new Date("@exam.ExamEnd");
                                    const timerElement = document.getElementById("timer-@exam.SubjectId");
                                    const examForm = document.getElementById("examForm-@exam.SubjectId");

                                    const countdown = setInterval(() => {
                                        const now = new Date().getTime();
                                        const distance = examEnd.getTime() - now;

                                        if (distance <= 0) {
                                            clearInterval(countdown);
                                            timerElement.innerHTML = "Time's up!";
                                            examForm.submit();
                                            return;
                                        }

                                        const minutes = Math.floor((distance / (1000 * 60)) % 60);
                                        const seconds = Math.floor((distance / 1000) % 60);

                                        timerElement.innerHTML = minutes + "m " + seconds + "s ";
                                    }, 1000);
                                })();
                            </script>
                        }
                        else
                        {
                            <div class="alert alert-secondary">Exam @exam.Status</div>
                        }
                    </div>
                }
            }
        </div>
    </div>
</div>
